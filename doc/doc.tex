\documentclass{article}
\usepackage{amsmath,url,tensor,amssymb,verbatim,graphicx}
\begin{document}
\section{Sources of information}

\subsection{Scope}

Could be fun to do trajectories in as much generality as a charged
particle in Kerr-Newman (spinning charged). Implementation in
mathematica, which appears to be open source:
\url{http://notizblock.yukterez.net/viewtopic.php?p=426} .
This suggests not depending too much on facts that may only hold for
the Schwarzschild spacetime, such as the ability to cover the whole
spacetime with a single chart, or the existence of several killing vectors
with corresponding conserved quantities. And note that in fact KS coordinates
do *not* cover the whole spacetime with a single chart, because they have
a coordinate singularity at theta=0 and pi.

Could also do stuff like maneuvering of rocket after infall to postpone hitting singularity
(which *can* help, contrary to popular belief -- see notes).

\subsection{MTW}

p. 826: ``Several well-behaved coordinate systems''

Box on p. 828 presents detailed calculations and motivations.

\subsection{Hawking and Ellis}

p. 155

\subsection{Wikipedia}

Nice presentation, readable notation.

\subsection{coordinate systems}

WP: $T,X$

MTW: $v,u$

H\&E: $t',x'$

$(T,X)=(v,u)=(t'/\sqrt2,x'/\sqrt2)$

H\&E's null coordinates: $(v',w')=(t'+x',t'-x')$

H\&E's Penrose diagram: $(v'',w'')=(\tan^{-1}(v'/\sqrt2),\tan^{-1}(v'/\sqrt2))$.

\section{Transformation from Schwarzschild to KS}

Throughout the following, let $m=1/2$, so the horizon is at $r=1$, i.e., $r$ is in units of Sch.~radius.

Exterior is $r>1$, regions I and III. Interior is $r<1$, regions II and IV.

\newcommand{\lambert}{\ell}

The following is notation I made up to keep the writing simple.
Define a variable $\lambert=r-1 $.
\begin{align}
  \operatorname{sc} &= \begin{cases}
\sinh, \qquad \text{exterior}\\
\cosh, \qquad \text{interior}
\end{cases} \\
  \operatorname{cs} &= \begin{cases}
\cosh, \qquad \text{exterior}\\
\sinh, \qquad \text{interior}
\end{cases} \\
  \operatorname{tc} &= \begin{cases}
\tanh, \qquad \text{exterior}\\
\coth, \qquad \text{interior}
\end{cases}\\
\sigma &= \begin{cases}
+1, \qquad \text{regions I and II, $V>0$}\\
-1, \qquad \text{regions III and IV, $V<0$, (the universe we can't reach)} 
\end{cases}
\end{align}

Then the transformation from Schwarzschild to KS is (MTW p.~827):

\begin{align}
  T &= \sigma \sqrt{|\lambert |} e^{r/2}\operatorname{sc}\frac{t}{2} \\
  X &= \sigma \sqrt{|\lambert |} e^{r/2}\operatorname{cs}\frac{t}{2} 
\end{align}

This transformation is supposed to fix coordinate singularities at the horizons where the
metric is degenerate, so it can't be one-to-one at the the horizons.

The following is nonstandard notation that I invented for convenience.
Let
\begin{equation}
  \rho = X^2-T^2 = -VW \qquad \text{see below for null coords $VW$},
\end{equation}
which is a measure of how far you are from the singularity, taking values on $(-1,\infty)$.
It's positive on the exterior, negative on the interior. Horizon is at
$\rho=0$, both singularities at $\rho=-1$. We have
\begin{equation}
  \lambert  = W(\rho/e).
\end{equation}
$W$ is the principal real branch of the Lambert W function (more info below).
Like $\rho$, $\lambert $ takes values on $(-1,\infty)$, and
the interpretation of its sign is also the same. 

The Lambert 
W function is defined
by $z=W(ze^z)$, i.e., it's the inverse of the function inside the parens. 
Maxima implementation is \texttt{lambert\_w}. Scipy has \texttt{lambertw}.
There is a GPL'd javascript implementation: \url{https://github.com/protobi/lambertw}.
High-performance C++ implementation: \url{https://github.com/DarkoVeberic/LambertW}.
Because W is defined as the inverse of a certain function, its derivative is easy
to express in terms of itself, $dW/dz=W/(z(1+W))=1/(z+e^W)$. The latter expression
looks more expensive to compute because of the exponential, but it's safer because
it doesn't misbehave at $z=0$, where the first one is an indeterminate form.
Maxima uses the equivalent (and also safe) form $e^{-W}/(1+W)$.

For large $\rho$,
$\lambert =\ln\rho-\ln(\ln\rho-1)+o(1)$.

The metric is
\begin{equation}
  ds^2 = B(dT^2-dX^2)-(1+\lambert )^2d\Omega^2,
\end{equation}
where
\begin{equation}
  B = \frac{4\lambert }{(1+\lambert )\rho} = \frac{4(r-1)}{r\rho}  = \frac{4}{r}e^{-r}.
\end{equation}
Here $(1+1/\lambert )\rho=re^r$ by the identity $e^{W(x)}=x/W(x)$. 
This type of expression will inevitably involve radial coordinates such as $r$, $\rho$, and
$\lambert $, even though KS doesn't even explicitly talk about radial coordinates; this makes
sense because the local, intrinsic properties of the spacetime only depend on the radial
coordinate (e.g., all curvature scalars are just functions of $1/r$).

I had to correct the coefficient in $B$ from 16 to 4
in order to get results from this metric to agree with results from Schwarzschild coords.
I'm darned if I can find my math mistake, but the perfect numerical agreement with
Schwarzschild on randomly chosen points is tantamount to a proof that the version with
the 4 in it is correct. This also checks with equation 6 in \url{https://arxiv.org/pdf/1401.1337.pdf} .

The inverse transformation is
\begin{align}
  r &= 1+\lambert  \\
  t &= 2\operatorname{sc}^{-1}(T|\lambert |^{-1/2}e^{-r/2}) = 2\operatorname{tc}^{-1}(T/X).
\end{align}

At the horizons, applying the inverse transformation gives $r=1$, $t=\pm\infty$. I'm not
sure if there's a nice interpretation of this, but the fact that it's not well-behaved
and one-to-one is what we expect at a place where we were removing a degeneracy of the metric.

For small radii,
the approximation $r\approx\sqrt{2(1-VW)}$ holds. 
Error in r is 20\% at $V=W=0.9$. Error in $r$ for $V=W=1-\epsilon$
shrinks like $\epsilon^{1/2}$ (relative) or $\epsilon$ (absolute).

For large radii, $r\approx \ln\rho =\ln(-VW)$.

\section{Null KS coordinates}

Let
\begin{align}
  V &= T+X\\
  W &= T-X,
\end{align}
which are the same as H\&E's $(v'/\sqrt2,w'/\sqrt2)$.
\begin{verbatim}
  W    V
   \  /
    \/
\end{verbatim}
Metric is (my calculation)
\begin{equation}
  ds^2 = B dVdW-\ldots d\Omega^2.
\end{equation}
See remarks below about checking this on v,w (Penrose) coordinates.

\section{Not well suited to large r and t}

At large values of $r$ and $|t|$, the asymptotic behavior of the $T,X$ and $V,W$ coordinates
is $re^{r/2}$ and $e^{|t|/2}$. Since the Schwarzschild radius of the sun is 3.0 km, that means
that the earth's orbit has $r\sim 10^8$, so K-S coordinates are ridiculously huge, much too
large to store as floating point numbers. For a general-purpose implementation, I see two possible
approaches:

(1) ``Charts of convenience.'' Although covering the whole spacetime with one chart is kind of the point of KS,
could use a different chart at large r. See notes in separate section on isotropic coordinates.
(Possibly
Eddington-Finkelstein are well suited to the region near the horizon?)

(2) Try to do another change of coordinates to get ones that don't misbehave so horribly at
large distances, while still covering everything with one chart. Don't want to use Penrose diagram
coordinates for this, because compactification would give them poor precision at large r. For example,
I think doing $\sinh^{-1}X$ results in a coordinate that varies linearly with r for large r. 

(3) ``Sliding chart.'' The KS coordinates obscure the Killing vector, and make it difficult
to do computations at large $|t|$, where KS coordinates get exponentially large.
Handle this by translating to t=0, and keeping track of the translation. This would be sort of like
having different charts of convenience for different eras of time (or different places on interior,
where t is spacelike). The transformation is actually pretty
simple in V,W coordinates. We store a point 
as (t,V,W), meaning the point (V,W) translated by an interval t in Schwarzschild coordinates.
Every point has a canonical form in which $|V|=|W|$, giving $t=0$. (This is a point on the X
or T axis.) To canonicalize, we take
\begin{align*}
  t &\rightarrow t+2\operatorname{tc}^{-1}[(V+W)/(V-W)] \\
  V &\rightarrow \pm\sqrt{\mp VW} = \pm\sqrt{\pm\rho} \quad \text{preserving original sign} \\
  W &\rightarrow \pm V \text{preserving the original sign}.
\end{align*}
At the step where we  canonicalize $t$, we have to manipulate $V$ and $W$, which in theory could
be impossible to express in machine floating point. However, as long as we always keep our points
\emph{close} to being canonical, this will never be a problem. When we compute things like Christoffel
symbols, we can just use the V,W part of the representation, ignoring the value of t. Could actually
delay canonicalization until $t$ exceeds some bound like $\pm5$. We want the canonicalization to be
a do-nothing for representations that are already canonicalized. This works, and, e.g., we can
always express things in terms of $(V+W)/(V-W)$ or its inverse in such a way that it doesn't equal
infinity. E.g., in region II, where $V$ and $W$ are both positive,
express this not as $\coth^{-1}[(V+W)/(V-W)]$ but as
$\tanh^{-1}[(V-W)/(V+W)]$.

Plan: Represent points in sch spacetime using three data structures for different regions of spacetime:

(a) (far) For $r>6$,
or $\rho\gtrsim 2000$, represent as Schwarzschild coordinates.

(b) (exterior, near horizon, large time) This is $1<r<6$ and $|t|>6$. Sliding chart.

(c) ( interior) For $r<1$, represent as $(V,W)$.

This is essentially what I implemented, except that I could never get the ``sliding chart''
or ``era'' mechanism to work properly and ended up ripping it out. The closest I got it to
working was in git commit 25d94127d35e942.

\section{Coordinates for Penrose diagrams}

Let
\begin{align}
  v &= f(V)\\
  w &= f(W),
\end{align}
where $f$ is some chosen such as $\tan{-1}$ (H\&E), $(2/\pi)\tan^{-1}$ (my default),
or $\tanh$ (used sometimes by Winitzki). The reason for the inverse tangent seems to be
that in the Minkowski case, it links geometrically to the maximal extension of the Einstein static universe
on a cylinder. Using my $(2/\pi)\tan^{-1}$, we have easy ways of describing stuff:
singularities at $v+w=\pm1$, horizons at $vw=0$, future null infinity at $v=1$ or $w=1$,
and past null infinity at $v$ or $w=-1$.

Letting $g={f^{-1}}'$, the metric in terms of the Penrose coordinates is (my calculation)
\begin{equation}
  ds^2 = B g(v)g(w)dvdw-\ldots d\Omega^2.
\end{equation}
If $f=\tan^{-1}$ then $g=\sec^2$,
and if $f=\tanh$ then $g(x)=1/(1-x^2)$. This makes sense because (1) the metric is never degenerate,
(2) $g$ blows up at infinity, and (3) $ds^2=0$ for fixed angular coordinates iff $dv=0$ or $dw=0$.

Some additional checks to do: 
Check factors of 2. Check that it makes sense if $f$ is the identity.
Compute Kretschmann invariant.

\section{Christoffel symbols}

The following are generated by running christoffel.mac and cutting and pasting the output into
christoffel.rb, then cleaning up by hand. Although I am currently having some doubt about a
factor of 4 in the definition of B,
changing B by a constant factor doesn't actually change these expressions, because the
coefficients that depend on that factor
are expressed in terms of B.

\begin{align}
\Gamma\indices{^V_V_V} &= (r^{-1}+r^{-2})We^{-r} \\
\Gamma\indices{^W_W_W} &= (r^{-1}+r^{-2})Ve^{-r} \\
\Gamma\indices{^\theta_V_\theta} = \Gamma\indices{^\phi_V_\phi} &= -WB/4r  \\
\Gamma\indices{^\theta_W_\theta} = \Gamma\indices{^\phi_W_\phi} &= -VB/4r  \\
%
\Gamma\indices{^V_\theta_\theta} &= -Vr/8\\
\Gamma\indices{^W_\theta_\theta} &= -Wr/8\\
\Gamma\indices{^V_\phi_\phi} &= -(Vr/8) \sin^2\theta\\
\Gamma\indices{^W_\phi_\phi} &= -(Wr/8) \sin^2\theta\\
%
\Gamma\indices{^\theta_\phi_\phi} &= -\sin\theta \cos\theta   \\
\Gamma\indices{^\phi_\theta_\phi} &= \cot\theta   
\end{align}

Part of my test suite checks
these by numerical sampling against the near-raw output from maxima.

Posted these at \url{https://physics.stackexchange.com/questions/404611/christoffel-symbols-in-kruskal-szekeres-coordinates}

\section{Isotropic coordinates}

There is a nice set of coordinates called isotropic coordinates,
described in Chrusciel, The geometry of black holes,
\url{https://homepage.univie.ac.at/piotr.chrusciel/teaching/Black%20Holes/BlackHolesViennaJanuary2015.pdf} ,
p.~19. These are basically Minkowski-ish coordinates that asymptotically approach the Minkowski
metric, with the metric being simple to express in them.  What Chrusciel describes are
the cartesian-style coordinates, while MTW describes the spherical style.

WP has an article ``isotropic coordinates,'' which doesn't superifically match that
closely with this topic. 
Similar: \url{http://ion.uwinnipeg.ca/~vincent/4500.6-001/Cosmology/IsotropicCoordinates.htm} .
See \url{https://physics.stackexchange.com/q/145342} .

MTW has p. 595, ex. 23.1, and p. 840, ex. 31.7, which deal with the spherical style.

Define $\tilde{r}$ implicitly according to
\begin{equation}
  r = \tilde{r}\left(1+\frac{1}{4\tilde{r}}\right)^2.
\end{equation}
The horizon is at $\tilde{r}=1/4$. Define coordinates $(t,x_i)$, where $t$ is
just the Schwarzschild $t$ coordinate, while $x_i$ are new coordinates that Chrusciel doesn't
explicitly define through any coordinate transformation to the Schwarzschild coordinates,
but that he does relate to Sch.~through the relation $\sum x_i^2=\tilde{r}$, and they
become Minkowski at large $r$. From comparison with MTW p. 840, eq. 31.22, I'm pretty
sure the idea is that $x_i$ are just the cartesian coordinates of a point on a sphere
of radius $\tilde{r}$, at angles $\theta$ and $\phi$. The metric has
\begin{align}
  g_{ii} &= -(1+1/4\tilde{r})^4 \\
  g_tt &= \left(\frac{1-1/4\tilde{r}}{1+1/4\tilde{r}}\right)^2.
\end{align}

\section{Geodesics that hit the singularity}

It would be nice to be able to compute these with good precision, e.g., to play with
stuff like how much you can prolong your life by using rocket engines after falling
through the horizon. Atkinson has a discussion of error estimates for Runge-Kutta on
p. 372, the idea being that you compare step size 2h with step size h. But this has
several problems for this application: (1) I think he assumes the function is lipschitz,
which isn't true at the singularity; (2) he's discussing error bounds on coordinates,
but I want error bound on the proper time when the coordinate reaches a certain value.

Suhartanto and Enright describe numerical methods for ODEs near a singularity:
``Typically
the stepsize is slowly decreased in size as the singularity is
approached with a high percentage of the attempted steps rejected.
The integration is usually terminated when the stepsize finally
reaches its minimum permitted value.''

WP
\url{https://en.wikipedia.org/wiki/Schwarzschild_geodesics#Orbits_of_test_particles}
has closed-form expressions for $t(\tau)$ and $r(\tau)$ for a radially infalling
massive test particle that starts at rest at infinity. Taking the limit near the singularity gives
$t\approx(3/2)\tau$ and $r\approx -[(3/2)\tau]^{2/3}$ (where I've assumed it hits
the singularity at $t=0$, $\tau=0$).

Or using MTW's expressions in Schwarzschild coordinates, I get
$r=12^{2/3}(-\tau)^{2/3}$ (or throw in a factor of $(2m)^{1/3}$ for
standard units). This makes sense because the 2/3 is the same exponent
as in Kepler's laws, should be universal based on units. This is for free-falling
from rest at an initial position $r_\text{max}$, and it ends up not depending
on $r_\text{max}$.

In Kruskal coordinates, the Christoffel symbols end up being dominated by
$\ddot{V}\approx -r^{-2}\dot{W}$ and $\ddot{W}\approx -r^{-2}\dot{V}$.

Or in S coords, the dominant C symbol gives $\ddot{r}\approx -(1/2)r^{-3}\dot{r}^2$.

The main point here is that in terms of errors and adaptation of RK,
we have a diffeq that misbehaves roughly like $y'=f(y)=y^{-3}$, so that
maybe we expect errors of order $f^{(3)}$, or $r^{-6}$. Errors in proper
time might then be of the same order, since proper time and r are related
by a power law?

The error in 4th-order Runge-Kutta with step size $h$ goes like $h^4r^{-6}$.
To keep this constant, we would need $h\propto r^{3/2}$. But for a massive
test particle infalling radially from infinity, this is simply $h\propto \tau$. Since the
step size is expressed in terms of an affine parameter, this simply means
making the step size proportional to how far we are from the singularity in terms of proper time.
If we were to follow this prescription, then the number of steps of integration would diverge
logarithmically as we approached the singularity.

Under the same assumption of $r\propto\lambda^{2/3}$, it probably makes sense
to extrapolate $r^{3/2}$ as a function of $\lambda$ to find when we expect
to hit the singularity. Or, with less computational effort, simply estimate
$\lambda_0=\lambda+(2/3)r/\dot{r}$. Let this factor of 2/3 be adjustable, and
call it $\alpha$.

The lowest-level Runge-Kutta routine can be given a trigger telling it to
return when r is projected to drop below 0, and then we can use the returned
coordinates and velocities to extrapolate to find the $\lambda$, $t$, and $r$
at which the geodesic terminates.

\section{Specialized coordinates for use near the singularity}

Press suggests ``to make
a pre-integration change of variables in the equations'' near a singularity.
The form of the exact solutions for radial infall from rest at infinity suggests
the substitution $u=r^{3/2}$, which is essentially the Keplerian scaling of times.
Call $(t,u)$ ``Keplerian'' coordinates. Christoffel symbols:
\begin{align*}
\Gamma\indices{^u_t_t} &= 3/(4u)-3/(4u^{5/3})  \\
\Gamma\indices{^t_t_u} &= -u^{1/3}/(3u^{4/3}-3u^2)  \\
\Gamma\indices{^u_u_u} &= \frac{1}{3}u^{-1/3}\frac{1-2u^{2/3}+u^{4/3}}{1-3u^{2/3}+3u^{4/3}-u^2} \\
%             u^{4/3}/((-9u)+9u^{5/3}+u^{1/3}(3-3u^2))\\
%             & -(2u^{2/3})/((-9u)+9u^{5/3}+u^{1/3}(3-3u^2))\\
%             & +1/((-9u)+9u^{5/3}+u^{1/3}(3-3u^2))  \\
\Gamma\indices{^i_u_i} = \Gamma\indices{^j_u_j} = \Gamma\indices{^k_u_k} &= 2/(3u)  \\
\Gamma\indices{^u_i_i} = \Gamma\indices{^u_j_j} = \Gamma\indices{^u_k_k} &= (3u^{1/3})/2-(3u)/2  
\end{align*}
For small $u$, the worst behavior by any of the Christoffel symbols is
to blow up like like $u^{-5/3}$. This seems a lot better than
Schwarzschild, which goes like $r^{-3}$. Transformation of vectors is simply
$v^u=(3/2)r^{1/2}v^r$.

For free-fall from rest at infinity, $u'(\lambda)$ is
constant, which makes event location trivial. For timelike radial free-fall in general,
$u(\lambda)$ is very gently curved, but is still differentiable near the singularity.

For timelike non-radial infalling, $u'$ and $i'$ blow up at the singularity, but
$t'$ approaches zero. The asymptotic behavior of $t'$ seems to be
$t'\propto|\lambda-\lambda_0|^{2/5}$. Very close to the singularity,
at $|\lambda-\lambda_0|$ on the order of $10^{-14}$ of the Schwarzschild radius,
it looks in my numerical data like $t'$ deviates from this rule and approaches
a small constant value, but this may be a numerical artifact.

If it were true that $\dot{t}\propto \lambda^{\ldots}$, then it would be the magic bullet for
event location.

To see whether Keplerian coordinates really help with performance, I tried a sample
problem with initial conditions being $r=0.01$, $E=2$, $L=0$ or $0.3$, $\Delta\tau=0.1\tau_s$,
where $\tau_s$ is the estimated time to reach the singularity. Found minimum
number of iterations needed to give 16 digits of precision on final $r$.

For $L=0$, Keplerian coordinates needed 17 iterations, Sch 46. Times were 1.3 ms vs 3.0 ms.
So this is a pretty big win, but $L=0$ is the case that the coordinates were designed for.

For $L=0.3$, the number of iterations required is basically the same, and the times were
nearly identical.

Conclusion: clever choices of coordinates may help enough to matter
in certain specialized regimes, but not in general.

With hindsight, it would have been smarter to choose the exponent in the Keplerian coordinates
to linearize the behavior for the $L\ne0$ case. This could still be worth doing, but is not
a ginormous win.

\section{Asymptotic behavior approaching the singularity}

In Schwarzschild coordinates, 
it seems empirically that $r$ sort of approximately goes like $\lambda^\alpha$
(where $\lambda\rightarrow0+$),
although $\alpha$ may not really be constant, may approach $0^+$, which would be more the flavor
of a logarithm. I get $\alpha$ at least as low as 0.2 close to the singularity.

Suppose we write down geodesic eqns and use conserved quantities $E=A\dot{t}$ and $L=r^2\dot{\phi}$.
Then
\begin{align*}
  \ddot{t} &= -Er^{-2}A^{-2}\dot{r} \\
  \ddot{r} &= -E^2/(2r^2A)+A\dot{r}^2/2r^2+L^2A/r^3,
\end{align*}
where $A=1-1/r$. Now approximate $A\approx -1/r$ and neglect the $E^2$ term. The first equation
becomes integrable.
\begin{align*}
  \dot{t} &= -Er \\
  \ddot{r} &= -\dot{r}^2/2r^3-L^2/r^4
\end{align*}
The first equation shows why $\dot{t}\rightarrow0$. In the second equation, if we assume
$r\propto \lambda^\epsilon$, then the $\ddot{r}$ term becomes negligible, and the solution
is $\epsilon=2/3$, which is the result for radial infall from rest at infinity --- but in
fact I don't really observe $r\propto \lambda^\epsilon$, so this is not super exciting.
If I instead assume that the $\dot{r}^2$ term is negligible, then the solution is
$r\propto\lambda^{1/3}$, which is more similar to what I observe when $L\ne0$, but still probably not
right.

Better: as in the WP article ``Schwarzschild geodesics,'' substitute the conserved quantities
into the metric. This results in an integral for proper time in terms of $r$,
\begin{equation*}
  \tau = -\int \left[E^2-(1+L^2r^{-2})(1-1/r)\right]^{-1/2}dr .
\end{equation*}
(The minus sign in front is specific to this situation.
Note that inside the horizon, $1-1/r$ is negative, so the expression inside the square brackets
is really a sum of two positive terms.)
I couldn't get Maxima or WA to integrate this, although various approximations and special
cases do seem to have integrals that are nasty, complex expressions in terms of elliptic integrals.
In the case where $L\ne0$, neglecting all but the $r^{-3}$ term gives $r\propto\lambda^{2/5}$,
and this matches up with my numerical observation that $\dot{t}\propto \lambda^{2/5}$.

Plan: try to put a lower bound on $\tau(r=0)$ using this integral, and also possibly extend that
to a lower bound when an external force acts.

For $L\ne0$, the proper time $\tau$ to move along a timelike geodesic from $r=R$ to $r=0$ is given by
\begin{equation*}
  \tau|L| = \int_0^R r^{3/2}(1-r+ar^2+br^3)^{-1/2} dr,
\end{equation*}
where $a=L^{-2}$ and $b=L^{-2}(E^2-1)$.
Let $\epsilon=r-ar^2-br^3$, $-\infty < \epsilon<1$. (Can't have $\epsilon\ge1$, because
then the integral becomes complex.) If we get close enough to the singularity, $0<\epsilon<1$,
so that the Taylor series of $(1-\epsilon)^{-1/2}$ converges and has only positive terms.
We can therefore put a lower bound on $\tau$ by truncating this series (which is not the
same as truncating according to exponents of $R$). Taking only the constant term gives
the bound
\begin{equation*}
  \tau|L| > \frac{2}{5}R^{5/2},
\end{equation*}
or, with the next term included,
\begin{equation*}
  \tau|L| > \frac{2}{5}R^{5/2}+\frac{1}{7}R^{7/2}-\frac{a}{9}R^{9/2}-\frac{b}{11}R^{11/2}.
\end{equation*}
When $L$ is small, this bound becomes a poor one, because we may need $r\lesssim L^3$ and
$r\lesssim L^3/(E^2-1)$ to get $\epsilon<1$.

For my purposes an upper bound on $\tau$ is of less interest, but if we want one,
we can put an upper bound $\epsilon_0$ on $\epsilon$ and substitute that
constant into the integral in place of $\epsilon$, giving
\begin{equation*}
  \tau|L| < \frac{2}{5}R^{5/2}(1-\epsilon_0)^{-1/2}.
\end{equation*}
There are two cases, depending on how $b$ compares to
$b_0=-a^2/3$. In the case where $b<b_0$, $\epsilon$ is increasing for all $r$, so we can
take $\epsilon_0=\epsilon(R)$. For $b>b_0$, $\epsilon$ is increasing for $r\le 0<r_0$,
where $r_0=-(a/3b)(1-\sqrt{1+3b/a^2})$ (which is positive regardless of the sign of $b$).
In this case we have to wait until $r<r_0$, and then the same method applies.
For very large values of $b$, i.e., ultrarelativistic particles, the upper bound on
$\tau$ given above will valid but weak, and it may be better to treat such cases as null geodesics.
If $R$ is small enough so that $\epsilon\approx r$ is a good approximation for all of
the remaining motion, then we have the approximate bound
\begin{equation*}
  \tau|L| \lesssim \frac{2}{5}R^{5/2}(1-R)^{-1/2}.
\end{equation*}
For $b>0$, this is a strict bound, but weaker than the previous one.

For a timelike geodesic with $L=0$, there are closed-form solutions for $\tau$. Let $c=E^2-1$.
For $c \ge 0$,
\begin{equation*}
\tau = {{\log \left(1+2\,c\,r-2\,\sqrt{c}\,\sqrt{r}\,\sqrt{c\,r+1}\right)
 }\over{2\,c^{{{3}\over{2}}}}}+{{\sqrt{r}\,\sqrt{c\,r+1}}\over{c}},
\end{equation*}
or in maxima notation
\begin{verbatim}
log((-2*sqrt(c)*sqrt(r)*sqrt(c*r+1))+2*c*r+1)/(2*c^(3/2))+(sqrt(r)*sqrt(c*r+1))/c
\end{verbatim}
In a series expansion, this is
\begin{equation*}
  \tau = \frac{2}{3}r^{3/2}-\frac{c}{5}r^{5/2}+\frac{3c^2}{28}r^{7/2}+\ldots,
\end{equation*}
which is consistent with the case of
$c=0$ (free fall from rest at infinity), where $\tau=(2/3)r^{3/2}$.
Maxima source code:
\begin{verbatim}
taylor(integrate(x^(1/2)*(1+c*x)^(-1/2),x,0,r)/r^(3/2),r,0,2);
\end{verbatim}
For $c<0$ and $r<-1/c$, we get a result that looks like it's going to turn out
complex, which seems to be a proof that $c>0$ for timelike geodesics.
For ultrarelativistic particles, we could have large values of $c$ that would
make the series expansion wrong, and the exact expression will not behave well
numerically. May want to treat such cases as null geodesics.

For a null geodesic with $L=0$, the solution is $r=\lambda$, $t=\lambda+\ln(1-\lambda)$
(or any affine reparametrization).

For a null geodesic with $L\ne0$, a quick and sloppy analysis of
$\tau(r)$ in the limit $E\rightarrow\infty$ gives $\propto
\tau^{2/5}$, i.e., the same as for $m\ne0$, since the same term in the
integrand for $\tau{r}$ still dominates. 

Summary of exponents $p$ in $r\propto \lambda^p$:

\begin{tabular}{lll}
  & $L\ne0$ & $L=0$ \\
$m\ne0$ & 2/5 & 2/3 \\
$m=0$   & 2/5 & 1
\end{tabular}

A possible simple algorithm for event location is the following. Estimate
$\lambda_s-\lambda > -(2/5)r/\dot{r}$, since all the exponents are at least
as big as 2/5.

\section{Choice of step size}

I tried an empirical study of the optimal step size, using a massive
particle infalling from $r_0<1$ with $E=2$ and $L=0.3$. Did this with
$r=0.9$, then 0.1, and decreasing roughly by decades. Took the
estimate $\tau_s=(2/5)(1/|L|)r_0^{5/2}$ for the time to hit the
singularity, and ran the simulation for $\Delta\tau=0.1\tau_s$,
finding final $r$. For each $r$, did calculations with a bunch of
different $n$ values, and made a log-log plot of error versus n.
(Error from assumed true value based on what the results seemed to be
converging to.) For each $r_0$,
found the optimal $n$, which was the one where the graph stopped
showing a decrease with a slope of $-4$ and flattened out.

For $r_0$ from 0.1 down to $10^{-8}$, found that the optimal $n$ was
remarkably constant at about 100-200. For $r_0=0.9$, optimal $n$ was more
like 3000, and for $r_0<10^{-8}$ it began to decrease rapidly, to an optimal
$n$ of 1 at $r_0=16^{-10}$.

Does this behavior correspond to any naturally defined physical distance scales?
Consider the quantities $a=L^{-2}$, $b=L^{-2}(E^2-1)$, and $\epsilon=r-ar^2-br^3$.
The first value of $r$ for which $\epsilon>0$ is about 0.01. So possibly a reasonable
rule of thumb is that for $r$ small enough to give positive $\epsilon$, we should
keep $\Delta n/\Delta \tau$ proportional to $1/\tau_s$, down to some cut-off.

If we
never had a cut-off, the computation time would be $n\sim \int d\tau/\tau$, which diverges
logarithmically. But we can have a cut-off, for several reasons:

(1) optimal n goes down
past a certain point (why?)

(2) at optimal n, the relative error $\delta r_f/r$ is always roughly equal to rounding
error, which means that the absolute error gets extremely small, probably negligible for
most applications

(3) for this particular spacetime, for various cases, I understand the asymptotic behavior
well enough analytically that, depending on what I'm trying to calculate, I may be able
to slap on the asymptotic result as a substitute for the remainder of the calculation

I tried paper-and-pencil calculations to estimate some kind of optimal scaling of the
step size, given the empirical observation that over short periods,
$\Delta n/\Delta \tau \propto 1/\tau_s$ for precision limited by rounding. The result
depends on what variable you want to know the error in ($\lambda$, $r$), and on how
you assume $r(\tau)$ behaves (which is different for different regimes of energy and
angular momentum). For the most common case ($L\ne0$, not ultrarelativistic), with
Runge-Kutta of order $M$, using error in $\tau$ as the criterion, the result I got
(not totally sure if this was right) was that one should scale the step size like
$dn/d\tau \sim \tau_s^\alpha$, with $\alpha=-1-2/5M$. (It's not at all obvious to me that
this is correct for general $M$, since my calculation assumes that some of the behavior
I observed holds regardless of $M$.) For $M=4$, this is $\alpha=-1.1$, which is kind
of a trivial difference from just taking $\alpha=-1$.

Try an empirical rule, applying it to timelike and null world-lines.
Let $\delta$ be the maximum relative error.
First, estimate
\begin{equation*}
  p = \left(1-\frac{r \ddot{r}}{\dot{r}^2}\right)^{-1},
\end{equation*}
but if $p$ lies outside $[2/5,1]$, bring it into that range.
(At the very beginning, we don't know $\ddot{r}$ yet, so take $p=2/5$.)
Estimate the distance in
affine parameter to the singularity as
\begin{equation*}
  \lambda_s-\lambda = p\frac{r}{\dot{r}},
\end{equation*}
but if this estimate violates the strict bounds found above, force it into that range.
If $r>r_\text{min}=\delta^{1/p}$, take the step size to be
\begin{equation*}
  \Delta\lambda=k\delta^{1/4}(\lambda_s-\lambda)^\alpha
\end{equation*}
(but never greater than $\lambda_s-\lambda$, and never take $r_\text{min}<10^{-8}$, because
smaller values don't seem to help).
If $r<r_\text{min}$, terminate the integration, taking the above estimate for $\lambda_s$
as the final $\lambda$, and freezing $t$ and the angular coordinates. (Note that
$(1-1/r)\dot{t}$ is conserved, so we're guaranteed that $\dot{t}$ goes to zero. It seems
that since $r^2 d\phi/d\tau$ is conserved, $\phi$ has to go crazy if $L\ne0$, but there's
not much we can do about that.)

The adjustable parameters are $k$ and $\alpha$. Tune these up so that
the desired precision $\delta$ is achieved with minimum computational effort.
From my previous empirical studies, it seemed like $\alpha\approx 1$, $k\approx 10$.
Playing around with the actual running algorithm, it seems like $\alpha\approx 0.5$, $k\approx 0.25$
is better. With these parameters, I seem to get precision in $\lambda_s$ of as good as
$\sim 10^{-12}$.

\section{Reissner-Nordstrom black hole (charge, no spin)}

MTW p. 840, ex. 31.8 gives the metric in Sch coords. For ``Kruskal-like coordinates,''
they give a reference to Graves and Brill (1960) and their own fig 34.4, p. 921,
which is a Penrose diagram.

\section{Arcsinh coordinates}

Let
\begin{align*}
  a & = \sinh^{-1} V \\
  b & = \sinh^{-1} W. 
\end{align*}
The motivation is that for large r and t, the
a and b coordinates basically scale like r and t, not exponentially, so they are more manageable numerically.
For large radii, $r\approx |a-b|$ (check this), so that lines of constant r are
approximately vertical lines on a spacetime diagram, and if a and b are both large,
$t\approx|a|+|b|$, so that lines of constant t are approximately horizontal lines.
The metric is
\begin{equation*}
  ds^2 = 2\mu dadb -\ldots,
\end{equation*}
where $\mu = (1/2)B\cosh a\cosh b$.

\IfFileExists{figs/graph.png}{%
  \begin{figure}[h]
    \centering
    \includegraphics{figs/graph.png}
    \caption{The $(a,b)$ coordinate chart. The positive $a$ and $b$ axes point northeast and northwest.
       Lines represent constant values of the Schwarzschild
       $(t,r)$ coordinates. Dark lines represent integer multiples of the Schwarzschild radius.
       Note the nearly rectilinear structure of the grid at large distances.}
  \end{figure}
}%
{%
  [Missing figure. To make the figure, go into the figs subdirectory, do a make, and then convert to png.]
}

The quantities we need can be calculated in the $(a,b)$ system without floating-point overflows.
In regions I and II ($a>0$), let $u$ be defined by
\begin{align*}
  u &= \ln(\pm \rho/e) \qquad \text{[+ in region I]} \\
    &= a+|b|+\ln(f/4e),
\end{align*}
where
\begin{equation*}
  f = (1-e^{-2a})(1-e^{-2|b|})
\end{equation*}
is positive and o(1). The variable $u$ basically scales like $r$.
Then we can compute $r$ without having to directly manipulate V and W:
\begin{equation*}
  r = 1+\ell=1+W(\pm e^u) \qquad \text{[+ in region I]}.
\end{equation*}
(For region II, the singularity is at $u=-1$, and the physical region is $u\le -1$.)
The function $W(e^u)$ is straightforward to compute --- see below.
The Schwarzschild time is
\begin{equation*}
  t = |a|+|b|+\ln\left(\frac{1-e^{-2|a|}}{1-e^{-2|b|}}\right).
\end{equation*}
To get the coefficient appearing in the metric,
\begin{equation*}
  \mu = \frac{1}{2re} e^{a+|b|-\ell}(1+e^{-2a})(1+e^{-2|b|}).
\end{equation*}
Since $\ell\approx a+|b|$ (does this hold in II?), the quantity inside the exponential is safe to evaluate.

Computation of $W(e^u)$:
Veberic, \url{https://arxiv.org/abs/1003.1628}, sec.~2.3, shows an iterative
scheme that only requires an initial guess for $W(x)$, and that can be expressed purely
in terms of $\ln x$. (The iteration scheme actually works for negative $x$ as well, because
it uses $\ln(x/W_n)$.

For the transformation from Schwarzschild coordinates to (a,b), let
\begin{equation*}
  x_\pm = \sqrt{|r-1|}\exp\left(\frac{r\pm t}{2}\right),
\end{equation*}
which is equivalent to $x_+= V$ and $x_-=|W|$.
Then
\begin{align*}
  a &= \sinh^{-1} x_+ \\
  b &= \pm\sinh^{-1} x_- \quad \text{[minus sign in region I]} \\
\end{align*}
If $x$ is too big to be represented in floating point, then we have the approximation
$\sinh^{-1} x = \ln(2x)+O(x^{-2})$. (Depending on the floating point representation,
it could happen close to the horizon that the exponential
factor is too big to represent, but $x$ is not big enough for $x^{-2}$ to be negligible.
Therefore we may have to use additional terms in the asymptotic expansion for the arcsinh.)
The jacobian is
\begin{align*}
  \frac{\partial a}{\partial t} &= \ \ \frac{1}{2}(1+x_+^{-2})^{-1/2} \\
  \frac{\partial b}{\partial t} &= \pm\frac{1}{2}(1+x_-^{-2})^{-1/2} \qquad \text{[$+$ in I]} \\
  \frac{\partial a}{\partial r} &= \ \ (1-1/r)^{-1} \frac{\partial a}{\partial t} \\
  \frac{\partial b}{\partial r} &= -(1-1/r)^{-1} \frac{\partial b}{\partial t}.
\end{align*}
In these expressions, $x_\pm$ may be too large to evaluate, in which case the $x_\pm^{-2}$ terms
can simply be neglected. The partials with respect to $r$ blow up at the horizon. The jacobian
for the transformation $(a,b)\rightarrow(t,r)$ is found by inverting the $2\times 2$ matrix
above.

Although the a-b coordinates are better suited to large distances and times than are the
raw Kruskal coordinates, they are not well suited to nonrelativistic motion. If you use them
to represent the earth orbiting the sun, then in relativistic terms, the earth is essentially
at rest, so that the trajectory is described approximately by $|a-b|=\text{constant}$.
You would naturally want to start simulating the earth's motion at $t=0$, and use a time step
of, say, one day. But in one day, both a and b increase by on the order of a light-day, which
is orders of magnitude greater than r.

Christoffel symbols can be found by transforming from $(V,W)$ to $(a,b)$ using the
transformation law given in \url{https://math.stackexchange.com/q/248267/13618}:
\begin{align*}
\Gamma\indices{^a_a_a} &= \tanh a + (r^{-1}+r^{-2})e^{-r}\cosh a\sinh b \\
\Gamma\indices{^b_b_b} &= \tanh b + (r^{-1}+r^{-2})e^{-r}\cosh b\sinh a \\
\Gamma\indices{^\theta_a_\theta} = \Gamma\indices{^\phi_a_\phi} &= -(B/4r)\frac{\sinh b}{\cosh a}  \\
\Gamma\indices{^\theta_b_\theta} = \Gamma\indices{^\phi_b_\phi} &= -(B/4r)\frac{\sinh a}{\cosh b}  \\
%
\Gamma\indices{^a_\theta_\theta} &= -(r/8)\tanh a\\
\Gamma\indices{^b_\theta_\theta} &= -(r/8)\tanh b\\
\Gamma\indices{^a_\phi_\phi} &= -(r/8) \tanh a\sin^2\theta\\
\Gamma\indices{^b_\phi_\phi} &= -(r/8) \tanh b\sin^2\theta\\
%
\Gamma\indices{^\theta_\phi_\phi} &= -\sin\theta \cos\theta   \\
\Gamma\indices{^\phi_\theta_\phi} &= \cot\theta   
\end{align*}
I never actually use these because I use the 5-dimensional ones instead.

\section{Fictitious 5th coordinate}
Use this to avoid the need for multiple coordinate charts in order to handle the coordinate singularities
at $\theta=0$ and $\pi$. Define cartesian coordinates
\begin{align*}
  i &= \xi \sin\theta \cos\phi \\
  j &= \xi \sin\theta \sin\phi \\
  k &= \xi \cos\theta ,
\end{align*}
where $\xi=1$ is a fictitious coordinate, constrained to be 1.

So we have a ``big space'' B=$(a,b,i,j,k)$, which consists of the maximal extension of the Schwarzschild
spacetime embedded in a higher-dimensional space, and a ``little space'' L=$(t,r,\theta,\phi,[\xi])$,
consisting of regions I and II without the horizons.

The coordinate transformation $T:L\to B$ is known in closed form from
books, uses only elementary functions, and is special-cased for I vs
II. The transformation $T^{-1}:B\to L$ is known in closed form from
books, involves functions like $W$, may not exist (horizons, III, IV),
and can be extended by precomposing with a ``V-flip'' transformation
$V\rightarrow -V$. It's differentiable, because $W$'s derivative can
be expressed in terms of $W$. 

The metric in L is the standard Schwarzschild metric.
The metric in B can be found by applying the jacobian ${T^{-1}}'$. It's analytic, implicitly involves W,
and in simplified form I think it's
\begin{equation*}
  ds^2 = 2\mu dadb -r^2(di^2+dj^2+dk^2).
\end{equation*}
This can be tested numerically in a drop-dead-simple way by just taking two
infinitesimal displacements at a point in L, transforming to B, and comparing inner products.

Since we only work in the chart B, transformations of vectors don't have to be
efficient, can be undefined, only have to happen on input and output. To transform vectors
from L to B, use $T'$, which is super simple and well behaved wherever $T$ is defined.
To go the other way, numerically invert the $5\times 5$ matrix for $T'$ at that point,
and throw away the $\xi$ component.

The Christoffel symbols in B can be found by combining the inverse of the metric
(which is analytic and well behaved, involves W) with the derivatives of the metric
(expressible in terms of W). On top of this we add the fictitious centripetal force
represented by
\begin{equation*}
  \Gamma\indices{^i_i_i} = \Gamma\indices{^i_j_j} = \Gamma\indices{^i_k_k} = \frac{i}{\xi^2},
\end{equation*}
etc. We constrain $\xi=1$, but it's probably a good idea to leave the $\xi^{-2}$ factor in
there for numerical stability. The resulting expressions may be messy. I can probably find simplified
forms, and if so, they can be tested numerically.

If I take the Schwarzschild metric with $r^2 d\Omega^2\rightarrow r^2(i^2+j^2+k^2)$ and
compute its Christoffel symbols (schwarzschild5.mac), I get:
\begin{enumerate}
\item the usual Schwarzschild symbols involving t and r
\item symbols like $\Gamma\indices{^i_i_r} = 1/r$, analogous to the standard
                          $\Gamma\indices{^\theta_\theta_r} = \Gamma\indices{^\phi_\phi_r} = 1/r$
\item symbols like $\Gamma\indices{^r_i_i} = 1-r$, analogous to the standard
                         $\Gamma\indices{^r_\theta_\theta}=1-r$ and
                         $\Gamma\indices{^r_\phi_\phi}=(1-r)\sin^2\theta$
\end{enumerate}
There is nothing like the standard $\Gamma\indices{^\theta_\phi_\phi}$ and
$\Gamma\indices{^\phi_\theta_\phi}$, because $(i,j,k)$ are cartesian.

I have facilities in the module angular for renormalizing a point so that it lies on the
$\xi=1$ sphere, and for adjusting a vector so it's tangent to the sphere. Empirically,
if I do these at each step in Runge-Kutta, the final results are actually no better; it
still acts like a 4th-order method with almost exactly the same constant of proportionality.
However, it's a good idea to invoke these adjustments before and after Runge-Kutta to avoid
nonsense results, e.g., I confused myself by doing initial conditions with $i=1$ and
$di/d\lambda\ne=0$.

Christoffel symbols, nearly raw maxima output:
\begin{align*}
\Gamma\indices{^a_a_a} &= (\sinh(a)e^r(r-1)^2+(\cosh(a)^2\sinh(b)+2\sinh(a)e^r)(r-1)+\sinh(a)e^r+2\cosh(a)^2\sinh(b))/ \\
                       & \qquad (\cosh(a)e^r+2\cosh(a)e^r(r-1)+\cosh(a)e^r(r-1)^2)  \\
\Gamma\indices{^i_a_i} &= -(\cosh(a)\sinh(b))/(e^r+2e^r(r-1)+e^r(r-1)^2)  \\
\Gamma\indices{^j_a_j} &= -(\cosh(a)\sinh(b))/(e^r+2e^r(r-1)+e^r(r-1)^2)  \\
\Gamma\indices{^k_a_k} &= -(\cosh(a)\sinh(b))/(e^r+2e^r(r-1)+e^r(r-1)^2)  \\
\Gamma\indices{^b_b_b} &= (\sinh(b)e^r(r-1)^2+(\sinh(a)\cosh(b)^2+2\sinh(b)e^r)(r-1)+\sinh(b)e^r+2\sinh(a)\cosh(b)^2)/ \\
                       & \qquad (\cosh(b)e^r+2\cosh(b)e^r(r-1)+\cosh(b)e^r(r-1)^2)  \\
\Gamma\indices{^i_b_i} &= -(\sinh(a)\cosh(b))/(e^r+2e^r(r-1)+e^r(r-1)^2)  \\
\Gamma\indices{^j_b_j} &= -(\sinh(a)\cosh(b))/(e^r+2e^r(r-1)+e^r(r-1)^2)  \\
\Gamma\indices{^k_b_k} &= -(\sinh(a)\cosh(b))/(e^r+2e^r(r-1)+e^r(r-1)^2)  \\
\Gamma\indices{^a_i_i} &= -(\sinh(a)(r-1)+\sinh(a))/(2\cosh(a))  \\
\Gamma\indices{^b_i_i} &= -(\sinh(b)(r-1)+\sinh(b))/(2\cosh(b))  \\
\Gamma\indices{^a_j_j} &= -(\sinh(a)(r-1)+\sinh(a))/(2\cosh(a))  \\
\Gamma\indices{^b_j_j} &= -(\sinh(b)(r-1)+\sinh(b))/(2\cosh(b))  \\
\Gamma\indices{^a_k_k} &= -(\sinh(a)(r-1)+\sinh(a))/(2\cosh(a))  \\
\Gamma\indices{^b_k_k} &= -(\sinh(b)(r-1)+\sinh(b))/(2\cosh(b))  \\
\end{align*}
These are all analytic functions, so they should be valid in all four regions. Also, we expect that
under the transformation $(a,b)\rightarrow(-a,-b)$, each $\Gamma$ should flip signs.\footnote{because it
should change by a factor of $(-1)^n$, where $n$ is the number of indices that are $a$ or $b$}

Simplified by hand:
\begin{align*}
\Gamma\indices{^a_a_a} &= \tanh a + (r^{-1}+r^{-2})e^{-r}\cosh a\sinh b \\
\Gamma\indices{^b_b_b} &= \tanh b + (r^{-1}+r^{-2})e^{-r}\cosh b\sinh a \\
\Gamma\indices{^i_a_i} &= -r^{-2}e^{-r}\cosh a\sinh b  \\
\Gamma\indices{^i_b_i} &= -r^{-2}e^{-r}\cosh b\sinh a  \\
\Gamma\indices{^a_i_i} &= -\frac{1}{2}r\tanh a\\
\Gamma\indices{^b_i_i} &= -\frac{1}{2}r\tanh b
\end{align*}
Massaged to avoid overflows:
\begin{align*}
\Gamma\indices{^a_a_a} &= \tanh a + \frac{\mu}{2}(1+r^{-1})\tanh b \\
\Gamma\indices{^b_b_b} &= \tanh b + \frac{\mu}{2}(1+r^{-1})\tanh a \\
\Gamma\indices{^i_a_i} &= -\frac{\mu}{2}r^{-1}\tanh b  \\
\Gamma\indices{^i_b_i} &= -\frac{\mu}{2}r^{-1}\tanh a  \\
\Gamma\indices{^a_i_i} &= -\frac{1}{2}r\tanh a\\
\Gamma\indices{^b_i_i} &= -\frac{1}{2}r\tanh b
\end{align*}

\section{Incomplete geodesics}
The singularities are at $\sinh a\sinh b=1$, which unfortunately isn't as simple to express in the
$(a,b)$ coordinates as in Penrose coordinates. However, evaluating the Christoffel will always
involve computing $r$ anyway, so if we want to see how close to are to a singularity, we can always
use that. Accurately handling incomplete geodesics turned out to be very tricky on my first try.
I'm probably best off just using someone else's adaptive Runge-Kutta code.

\section{Simulating images from near a black hole}

What is published in the literature seems to be mostly weak-field approximations for an observer
at infinity. I want the exact results for an observer at any r, even, e.g., inside the horizon of
the Schwarzschild spacetime.

We can't assume the observer is stationary, since, e.g., there are no stationary observers inside a
black hole's horizon. If we wish, we can pick some standard state of motion for the observer, but this state
of motion would have to depend on r. Given the aberration and Doppler shift for this observer,
we can always do an SR transformation of the frequency covector or the momentum vector to get
the view from other states of motion. For a spacetime with spherical symmetry,
a pretty natural reference state of motion would be
the motion of an observer infalling radially from rest at infinity.

Let $P_u p=p-[(p\cdot u)/(u\cdot u)]u$ be the projection of the vector $p$ perpendicular to $u$,
where $u$ is future timelike. In the rest of this discussion, consider the Schwarzschild spacetime.
An observer in the reference state of motion, with four-velocity $u$,
has no tangential motion, so if they've inertially transported their radial vector with them, then
that vector lies in the $t-r$ plane, and it can be found by taking $P_u$ on any vector that is not
parallel to $u$, which works with either $\hat{t}$ or $\hat{r}$. Call this (outward) radial
vector $\rho$, so, e.g.,
$\rho=\widehat{P_u\hat{t}}$. For a ray of light that we observe with momentum vector $p$, we have
the spacelike part $P_u p$. The observer then sees this ray coming in at an angle given by
$\cos\alpha=\rho \cdot \widehat{P_u p}$.

This angle $\alpha$ connects to some angle $\beta$ on the celestial
sphere at infinity. Because solutions of the geodesic equation are
unique, we can express $\beta$ as a function of $\alpha$, as in
reverse ray-tracing. We then have a function of two variables
$f_r(\alpha)=\beta-\alpha$, where $f$'s dependence on the observer's
state of motion is subsumed in the choice of a standard state of
motion. $f$ is odd and has domain probably smaller than $(-\pi,\pi)$. We can
also define a similar function for the Doppler shift, but this is trivial
to compute because we have a conserved energy in this spacetime.

If I wanted to compile tabular data as a function of both $r$ and $\alpha$,
for interpolation, it would only be necessary in principle to compute a
one-parameter family of geodesics, because every point on such a geodesic
is an $(r,\alpha)$ combination. However, this would not give a nice evenly spaced
grid.

To test my computations of $f$, I could find $f_r(\pi/2)$ for large $r$, and
compare with weak-field approximations for the deflection of light.

Because pixels don't map one-to-one to pixels, intensities need to be
adjusted by the jacobian or something, i.e., it would be helpful to
know not just $f$ but $\partial f/\partial\alpha$. This probably happens for
free if I find a polynomial approximation or something. Also probably want
input image to be high resolution or have good interpolation on it. 
Further thoughts on this: A lot of this is thoroughly covered in Riazuelo.
I think the idea is that by Liouville's theorem, surface brightness is conserved,
and therefore brightness is amplified by a factor $f=(\sin\alpha d\alpha)/(\sin\beta d\beta)$,
which Riazuelo says includes the Doppler shift of intensity. We get a discrete approximation
to $f$ simply from our table of $\beta$ as a function of $\alpha$.

Because the domain of $f$ is not obvious, and $f$ may oscillate wildly as it
approaches the endpoints of its domain, it's not obvious in advance what
kind of interpolating or approximating scheme to use, e.g., Chebyshev polynomials
may not be the best choice.

Even without numerical integration, there is a lot we can say about the Schwarzschild case.
The tangent vector is determined by $L/E$ and $r$:
\begin{equation*}
  \frac{d\phi}{dr} = \pm r^{-2}\left[\left(\frac{L}{E}\right)^{-2}-A\right]^{-1/2}
\end{equation*}
and
\begin{equation*}
  \frac{d\phi}{dt} = \left(\frac{L}{E}\right)Ar^{-2}.
\end{equation*}
(At infinity, these simplify because we have $dr/dt=\pm 1$ and $A=1$.) So if we know that a ray
moves from $(r,\phi)$ to $(r',\phi')$, we pretty much know the aberration angle, except that there
can be a sign ambiguity because trajectories in 3-space can be self-intersecting.
These two equations are also a convenient way to set up initial conditions for a ray in terms
of the well-behaved parameter $L/E$.
For rays that don't pass in through the horizon, the radius of perihelion is $r_0=|L/E|A^{1/2}$, where
$A=1-1/r$. For $r \ll 1$, it seems like $\phi$ goes crazy, although I'm not sure if I'm interpreting that
correctly.

Plan: Pick an $r$ for the observer and determine their velocity vector $u$.
Start from $L/E=0$ and then iterate through higher and higher values.
If $r>1$, then $|L/E| \le rA^{-1/2}$ for
straightforward reasons. For $r<1$, there is no maximum, but large values don't
get to null infinity (?).
Interpolate between geodesics that I simulate, until I get to angles that are
either outside of the projection screen or that intersect the horizon.

Riazuelo goes to deflection angles of up to $5\pi$, says that's usually enough to
get all interesting visible effects. He seems to say that the small deflections are basically
SR doppler shifts, because the observer is free-falling (same idea I had). Although this seems to get the sign
wrong, it does seem to correctly predict the absolute value of the slope to be $\approx r^{-1/2}$,
which seems close to what I see numerically. Numerically, what I think I actually see for
small $\alpha$ is
\begin{equation*}
  \alpha-\beta\approx (r^{1/2}-1)^{-1}\alpha.
\end{equation*}
The actual results drop lower than this before coming back up. I use this approximation to
improve the quality of interpolation.

For $\alpha>\pi/2$, $L/E=\pm (1/2)3^{3/2}$ corresponds to the photon sphere, the unstable innermost
circular orbit (at $r=3/2$), which can be occupied only by massless particles. For an observer at $r>3/2$,
the upper limit on $\alpha$ corresponds to the time-reversal of the case where a photon starts on
the photon sphere and then flies outward. Therefore for the Schwarzschild spacetime, this is a good,
accurate way to judge the largest $\alpha$ that we need to consider. In reality, we stop evaluating
$\beta(\alpha)$ before this, because we only go up to a certain deflection angle such as $5\pi$,
but it's helpful to have this estimate in order to decide what angles to try, and the maximum angle
we actually end up doing is quite close to the estimate.

It's useful to know the function $\alpha_\text{max}(r)$ giving the greatest $\alpha$ at which rays
are observed by an observer at a given $r$ in the Schwarzschild spacetime. I have this
implemented in \texttt{alpha\_max\_schwarzschild}. In principle, this constitutes a 
closed-form expression for this function, but the math involves a fairly long series of calculations with
three-component vectors, so I got bogged down when I tried to write out a formula on a piece of
paper. There are two cases, $r\le 3/2$ and $r\ge 3/2$, see Riazuelo, p.~4.

For $r\ge 3/2$, the following approximation is good to about 1\%:
\begin{equation*}
  \pi-\alpha_\text{max} \approx \frac{(1/2)3^{3/2}}{r}(1+r^{-1/2})(1.0169-0.3308r^{-2}-0.2325r^{-4})
\end{equation*}
Here $(1/2)3^{3/2}$ is the $L/E$ for the photon sphere. 
I'm guessing that for large $r$, the polynomial factor is actually best approximated by 1,
but it's hard to tell because rounding errors get big in the implementation of the exact result.

For $r<3/2$, we need the other branch of the function 
(a ray with $\dot{r}<0$ at observation, simulated backward in time as emission with $\dot{r}>0$)
and the opposite sign on the inequality on $|L/E|$.
I get $\lim_{r\rightarrow 0}\alpha_\text{max}=\pi/2$,
which seems to be right based on the caption of Riazuelo's fig.~16, although I haven't worked out the
physics of why this should be true. Numerically, I seem to
get $\alpha_\text{max}(1)=\cos^{-1}(5/8)$, which disagrees with
Riazuelo?? For further confusion, he claims it should be $\delta=\pi-\alpha=\cos^{-1}(23/31)$,
which he says is $2\delta=82.1$ degrees, but in fact the first expression gives about 84 degrees,
while obtaining the decimal approximation seems to require an input of $23/30.5$ to the inverse cosine.


\subsection{Doppler shifts}

The Doppler effects are surprisingly subtle, even for observers at highly relativistic $r$.
For the observer in my standard state of motion, free-falling from rest at infinity, the Doppler
effect for a star directly overhead can be calculated in closed form. I have this as an example
in GR 7. At the horizon, it's only a factor of 2. For the standard observer,
Doppler shifts turn out to be redshifts for stars
directly overhead (as we would expect intuitively based on semi-Newtonian reasoning, because
we're infalling, away from the sources), and blueshifts for horizon-grazing angles.

\section{Literature on ray tracing}

some guy's web page with nice images, black hole ray tracing:
\url{http://www.stephenbrooks.org/misc/blackhole/}

Riazuelo
\url{https://arxiv.org/abs/1511.06025} He never mentions anything about the code itself; presumably
it's not open source. Paper says he only did Schwarzschild, a forthcoming paper will
do other spherically symmetric spacetimes.
Informational page about the image he put on WP: \url{http://www2.iap.fr/users/riazuelo/bh/APOD.php}
His faculty page: \url{http://www2.iap.fr/users/riazuelo/index.php}

James et al., \url{https://arxiv.org/abs/1502.03808} DNGR, the code used for Interstellar.
Handles spacetimes without spherical symmetry. DNEG's web site
\url{http://www.dneg.com/black-holes/} . It appears to be a collaboration between Kip Thorne and
DNEG, which is apparently a commercial special-effects company?
Am J Phys paper \url{https://aapt.scitation.org/doi/full/10.1119/1.4916949}

Karimi et al., \url{https://arxiv.org/abs/1001.2177}

Mueller and Weiskopf, \url{https://pdfs.semanticscholar.org/db54/08caceaabf1d5086accabfe9102c57ca80e5.pdf} ,
copy hoarded in \url{Papers/mueller_2011.pdf}.

Kuchelmeister, GpuRay4D: \url{http://cpc.cs.qub.ac.uk/summaries/AEMV_v1_0.html}
Code that uses GPU, something called CUDA (a library?). GPL licensed.

\section{Star fields}

For simulated black hole views, I need a full-sky image, because rays that graze the horizon
get deflected through arbitrarily large angles.

The best-known open-source planetarium software seems to be Celestia, but its FAQ
seems to say that it can't really analyze colors or wavelengths quantitatively.

There's a set of large-solid angle views of the plane of the Milky way at a variety
of wavelengths: \url{https://asd.gsfc.nasa.gov/archive/mwmw/mmw_allsky.html} They had
a poster, which is out of print, but which you can download at 300 dpi, 8x10. Unclear
copyright status. These are probably not that useful for my purposes, because they
aren't whole-sky.

ESO high-resolution panorama of the milky way:
\url{https://en.wikipedia.org/wiki/File:ESO_-_The_Milky_Way_panorama_(by).jpg}
``For copyright reasons, we cannot provide here the full 800-million-pixel original image, which can be requested from Serge Brunier.''

Three whole-sky images with false color:
\url{https://apod.nasa.gov/apod/ap100709.html}
\url{https://apod.nasa.gov/apod/ap050925.html}
\url{https://apod.nasa.gov/apod/ap101227.html}
Copyrights owned by authors of the research, have to contact them for permissions.

Javascript simulation of SR Doppler shifts using a star catalog:
\url{http://specialrelativity.net/animations/starfield/starfield.html?beta=0.8&color=on&circles=on&avgstellardensity=0.11&starpopulation=yalebsc&limitingMag=5&projection=stereographic&anim=on&runningTime=8}
Scroll down for info and options.
More physics explanation: \url{http://specialrelativity.net/part2.html#Starfield}
Simulation was written by John O'Hanley, software appears not to be open-source licensed.
References this AJP paper by McKinley and Doherty, which I can't find without a paywall:
\url{https://aapt.scitation.org/doi/10.1119/1.11834} Doherty sounds like a cool guy, rock
climber, Exploratorium employee; is dead; his web page: \url{http://www.exo.net/~pauld/index.html}
Doherty's still images: \url{http://www.exo.net/~pauld/stars/PD_images_relativ.html}

Work by Alain Riazuelo: Animation of lensing,
distant observer: \url{https://commons.wikimedia.org/wiki/File:BlackHole_Lensing.gif}
His wikimedia commons page says he has a permanent job at CNRS, but he may be dead or
may have left or retired, because all the links are broken.
Simulated view from $r=9r_s$: \url{https://commons.wikimedia.org/wiki/File:BH_LMC.png}
Since $r/r_s$ is large, it's possible that this just doesn't include any Doppler shifts.
Would nevertheless be useful as a check on whether an image I produce is correct.

\subsection{Doppler shifts}

The most general equation for a Doppler shift is $\omega \propto u_av^a$, where $u$ is the normalized
four-velocity of an observer or emitter, and $v$ is the four-velocity of the ray, calculated according
to some affine parameter. It can only be a proportionality because the affine parameter is arbitrary,
as is the signature. To see that this equation makes sense, consider that $\omega\propto p$ by
the Planck relation, and $p\propto v$.

As a simple example, consider emission from rest and detection
by an observer at rest in the Schwarzschild spacetime, with $A=1-1/r$.
The stationary observer or emitter has $|u|=1$, so $u^t=A^{-1/2}$.
Then because the quantity $Av^t$ is a constant along the ray's trajectory, we have
$\omega \propto u_t v^t = Au^t v^t = A\cdot A^{-1/2}\cdot A^{-1}=A^{-1/2}$.

In the Newtonian limit, an observer
infalling from rest at infinity has $v=r^{-1/2}$, so that the kinematic frequency redshift
of light emitted by a distant star is $1-r^{-1/2}$. This is
always bigger than the relativistic gravitational blueshift, which I guess tells us that
the kinematic redshift is a semi-Newtonian effect that is $O(v)$, while the gravitational blueshift is
a relativistic effect that is $O(v^2)$.

For emission from outside the horizon and
detection from inside, I have an analysis written up as an example
in GR 7.1.  The following papers talk about this sort of
thing: Riazuelo, \url{arxiv.org/abs/1511.06025}, caption to fig.~16;
Kassner, \url{arxiv.org/abs/1608.07511}; Grib,
\url{arxiv.org/abs/0906.1442}.  They all say that nothing special
happens at the event horizon, and you don't see the infinite future of
the universe.

\subsection{Behavior of deflection at grazing}

Empirically, for $1<r<\infty$, I find that $\beta+\ln(\alpha_\text{max}-\alpha)$ is a slowly
varying function of $\alpha$ and of $\ln r$. This tames the behavior of the function
$\beta(\alpha)$ so that we can interpolate accurately. There is a close physical analogy
with a pendulum at large amplitudes, for which the period varies as an elliptic integral,
whose asymptotic behavioris $K(1-\epsilon)\approx(1/2)\ln(2\epsilon)$.

\subsection{Process of generating an image}

optics.py -- Generates several tables of data about the view of an observer free-falling from rest at infinity,
who is currently at distance $r$ from the black hole.
(This could be corrected using SR for an observer in some other state of motion.) These are also
written to csv files so that I can inspect them, e.g., for debugging.
The format of
each row of the aberration table is $[r,\alpha,\beta,\beta-\alpha,f]$, where $\alpha$ is the direction
of the ray as seen by the observer (zero=away from the black hole), $\beta$ is the actual direction
on the celestial sphere, and $f$ is the factor by which the brightness of light is amplified because
of lensing. Format of stars table is $[\alpha,\phi,I,ln\_temp]$, where $\phi$ is azimuthal angle, $I$ is
brightness (first normalized to zero magnitude, but then taking $f$ into account), and ln\_temp is
a color temperature expressed as ln(kelvin).
The table of stars is based on a catalog of bright stars down to 7th magnitude, supplemented by
fake stars that are randomly generated based on a GAIA map and a statistical distribution of
magnitudes. There is also a table of velocity vectors of the rays at observation, for use in
calculating Doppler shifts.

render.py -- Module with a function render() called by optics.py.
Reads the data generated by optics.py and generates three pixel arrays, consisting of
brightness, hue, and saturation. When sources overlap, hue and saturation are based on a brightness-weighted
average. Adjusts intensities using a gamma correction (with the $y=x$ points on the graph being
zero intensity and unit brightness, i.e., zero magnitude), then multiplication by an exposure factor.
The HSV values are floating-point values, with hue being defined as 0=red, 1=blue,
and saturation running from 0 to 1. Writes stars.json containing the three pixel arrays.

render.rb -- Reads the pixel arrays from stars.json and converts them into a PNG file.

\section{Literature}

Bacchini, ``Generalized, energy-conserving numerical simulations of particles
in general relativity. I. Time-like and null geodesics,''
\url{https://arxiv.org/abs/1801.02378} -- assumes a static spacetime

Chan, ``GRay2: A General Purpose Geodesic Integrator for Kerr Spacetimes,''
\url{https://arxiv.org/abs/1706.07062} --
Cartesian Kerr-Schild coordinates, describes software GRay2, which runs on GPUs;
older version GRay at \url{https://github.com/luxsrc/gray} ; Chan on github:
\url{https://github.com/chanchikwan}

Lewis and Kwan, ``No Way Back: Maximizing survival time below the Schwarzschild event horizon,''
\url{https://arxiv.org/abs/0705.1029} -- They say they used odepack, but nothing about what
routine they used or how they managed the singularity. They quote errors on the order of
$10^{-4}$, which is good enough for their purposes but would be sad for general-purpose use.

Semerak, ``Approximating light rays in the Schwarzwschild field,''
\url{https://arxiv.org/abs/1412.5650} -- An ad hoc prescription with finite errors,
allows finding $r(\phi)$.

Boonserm et al., ``Near-horizon geodesics for astrophysical and idealised
black holes: Coordinate velocity and coordinate acceleration,''
https://arxiv.org/abs/1710.06139.pdf -- compares various coordinate systems
and behavior of coordinate acceleration near the horizon for an infalling particle

\end{document}
